<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maze Monkey Game</title>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
    }

    canvas {
      display: block;
      margin: 0 auto;
      background-color: #000;
    }

    /* Start button */
    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px;
      padding: 15px 30px;
      background-color: #ff9800;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    /* Play Again button */
    #playAgainButton {
      display: none;
      position: absolute;
      top: 83%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<canvas id="gameCanvas" width="800" height="300"></canvas>

<button id="startButton">Start!</button>
<button id="playAgainButton">Play Again?</button>

<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const startButton = document.getElementById("startButton");
  const playAgainButton = document.getElementById("playAgainButton");

  /* ================= MAZE ================= */
  const maze = [
    "11111100011111111111",
    "10000001000001000001",
    "10111101111101011101",
    "10101001000001010001",
    "10101111011111010111",
    "10001000000000010001",
    "00111111111111111111",
  ];

  const ROWS = maze.length;
  const COLS = maze[0].length;
  const TILE_SIZE = Math.min(canvas.width / COLS, canvas.height / ROWS);

  /* ================= PLAYER ================= */
  let playerCol = 0;
  let playerRow = 6;

  /* ================= GOAL ================= */
  const goalCol = 18;
  const goalRow = 5;

  /* ================= MONKEY ================= */
  const MONKEY_SIZE = TILE_SIZE * 2;
  let monkeyX = 0;
  let monkeyY = 0;
  let monkeyVisible = false;
  let monkeyClicks = 0;
  let monkeyTimer = 0;
  const MONKEY_MOVE_INTERVAL = 2000;

  /* ================= GAME STATE ================= */
  let gameState = "START"; // START, MAZE, CLICK_MONKEY, CAPTURE_MONKEY, END_GAME

  /* ================= SELECTION RECT ================= */
  let selecting = false;
  let selStartX = 0, selStartY = 0, selEndX = 0, selEndY = 0;

  /* ================= SOUNDS ================= */
  const phoneMessageSound = new Audio('http://asukatae.github.io/games/phonering.mp3');
  const boinkSound = new Audio('http://asukatae.github.io/games/boink.mp3');
  const tadaSound = new Audio('http://asukatae.github.io/games/tada.mp3');

  /* ================= INPUT ================= */
  document.addEventListener("keydown", e => {
    if (gameState !== "MAZE") return;

    let newCol = playerCol;
    let newRow = playerRow;

    switch (e.key.toLowerCase()) {
      case "w": newRow--; break;
      case "s": newRow++; break;
      case "a": newCol--; break;
      case "d": newCol++; break;
      default: return;
    }

    if (canMove(newCol, newRow)) {
      playerCol = newCol;
      playerRow = newRow;
    }
  });

  canvas.addEventListener("mousedown", e => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if (gameState === "CLICK_MONKEY" && monkeyVisible) {
      if (x >= monkeyX && x <= monkeyX + MONKEY_SIZE &&
          y >= monkeyY && y <= monkeyY + MONKEY_SIZE) {
        monkeyClicks++;
        boinkSound.play();
        if (monkeyClicks >= 3) gameState = "CAPTURE_MONKEY";
      }
    } 
    else if (gameState === "CAPTURE_MONKEY") {
      selecting = true;
      selStartX = selEndX = x;
      selStartY = selEndY = y;
    }
  });

  canvas.addEventListener("mousemove", e => {
    if (!selecting) return;
    const rect = canvas.getBoundingClientRect();
    selEndX = e.clientX - rect.left;
    selEndY = e.clientY - rect.top;
  });

  canvas.addEventListener("mouseup", () => {
    if (!selecting || gameState !== "CAPTURE_MONKEY") return;
    selecting = false;

    const left = Math.min(selStartX, selEndX);
    const right = Math.max(selStartX, selEndX);
    const top = Math.min(selStartY, selEndY);
    const bottom = Math.max(selStartY, selEndY);

    if (monkeyX >= left &&
        monkeyX + MONKEY_SIZE <= right &&
        monkeyY >= top &&
        monkeyY + MONKEY_SIZE <= bottom) {
      monkeyVisible = false;
      tadaSound.play();
      gameState = "END_GAME";
    }
  });

  /* ================= HELPERS ================= */
  function canMove(col, row) {
    if (row < 0 || row >= ROWS || col < 0 || col >= COLS) return false;
    return maze[row][col] === "0";
  }

  function spawnMonkey() {
    monkeyX = Math.random() * (canvas.width - MONKEY_SIZE);
    monkeyY = Math.random() * (canvas.height - MONKEY_SIZE);
    monkeyVisible = true;
  }

  function resetGame() {
    gameState = "MAZE";
    playerCol = 0;
    playerRow = 6;
    monkeyVisible = false;
    monkeyClicks = 0;
    monkeyTimer = 0;
    selecting = false;
    playAgainButton.style.display = "none";
  }

  /* ================= GAME LOOP ================= */
  let lastTime = 0;
  function gameLoop(time) {
    const dt = time - lastTime;
    lastTime = time;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (gameState === "START") {
      return requestAnimationFrame(gameLoop);
    }

    if (gameState === "MAZE") {
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          if (maze[r][c] === "1") {
            ctx.fillStyle = "gray";
            ctx.fillRect(c * TILE_SIZE, r * TILE_SIZE, TILE_SIZE, TILE_SIZE);
          }
        }
      }

      ctx.font = `${TILE_SIZE}px serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText("ðŸ’", goalCol * TILE_SIZE + TILE_SIZE / 2,
                          goalRow * TILE_SIZE + TILE_SIZE / 2);
      ctx.fillText("ðŸ˜", playerCol * TILE_SIZE + TILE_SIZE / 2,
                          playerRow * TILE_SIZE + TILE_SIZE / 2);

      if (playerCol === goalCol && playerRow === goalRow) {
        gameState = "CLICK_MONKEY";
        spawnMonkey();
        phoneMessageSound.play();
      }
    }

    else if (gameState === "CLICK_MONKEY" || gameState === "CAPTURE_MONKEY") {
      monkeyTimer += dt;
      if (monkeyTimer >= MONKEY_MOVE_INTERVAL) {
        spawnMonkey();
        monkeyTimer = 0;
      }

      if (monkeyVisible) {
        ctx.font = `${MONKEY_SIZE}px serif`;
        ctx.fillText("ðŸ’", monkeyX + MONKEY_SIZE / 2,
                            monkeyY + MONKEY_SIZE / 2);
      }

      if (selecting) {
        ctx.fillStyle = "rgba(0,255,0,0.3)";
        ctx.fillRect(
          Math.min(selStartX, selEndX),
          Math.min(selStartY, selEndY),
          Math.abs(selEndX - selStartX),
          Math.abs(selEndY - selStartY)
        );
      }

      ctx.fillStyle = "white";
      ctx.font = "20px Arial";
      ctx.fillText(
        gameState === "CLICK_MONKEY"
          ? "â˜Žï¸ Hit the monkey three times!"
          : "â˜Žï¸ Use the net to capture the monkey!",
        canvas.width / 2, canvas.height - 20
      );
    }

    else if (gameState === "END_GAME") {
      ctx.font = "120px serif";
      ctx.fillText("ðŸ™ˆ", canvas.width / 2, canvas.height / 2);
      ctx.font = "28px Arial";
      ctx.fillText("You Win!", canvas.width / 2, canvas.height / 2 + 80);
      playAgainButton.style.display = "block";
    }

    requestAnimationFrame(gameLoop);
  }

  startButton.addEventListener("click", () => {
    startButton.style.display = "none";
    resetGame();
  });

  playAgainButton.addEventListener("click", resetGame);

  requestAnimationFrame(gameLoop);
</script>

</body>
</html>
